<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Admin - FoodBot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layouts.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin.css') }}">
</head>
<body>
    <div class="header">
        <h1>üîß Admin</h1>
        <div class="header-actions">
            <a href="/admin/weekly">üìÖ Wochenplanung</a>
            <a href="/stats">üìä Statistiken</a>
            <a href="/history">üìú Historie</a>
            <a href="/kitchen">üç≥ K√ºche</a>
            <a href="/">üì° Touch</a>
            <a href="/logout">üö™ Logout</a>
        </div>
    </div>
    
    <div class="container">
        {% if message %}
        <div class="message">{{ message }}</div>
        {% endif %}
        
        <div class="grid grid-2">
            <!-- Men√º Card -->
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">üçΩÔ∏è</span>
                    <h2>Men√º f√ºr heute</h2>
                </div>
                
                <form method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="checkbox-label">
                        <input type="checkbox" id="zwei_menues" name="zwei_menues_aktiv" value="1" 
                               {% if menu and menu.zwei_menues_aktiv %}checked{% endif %}
                               onchange="toggleMenuInputs(this.checked)">
                        <label for="zwei_menues" style="margin: 0;">Zwei Men√ºs anbieten</label>
                    </div>
                    
                    <div class="info-box">
                        <strong>‚è∞ Anmeldefrist</strong>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                            <div class="checkbox-label" style="margin: 0;">
                                <input type="checkbox" name="deadline_enabled" value="1" 
                                       {% if not menu or menu.deadline_enabled %}checked{% endif %}>
                                <span>Frist aktiv</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span>Bis:</span>
                                <input type="time" name="registration_deadline" 
                                       value="{{ menu.registration_deadline if menu else '19:45' }}" 
                                       style="width: 120px; padding: 8px;">
                                <span>Uhr</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="single-menu" class="menu-inputs {% if not menu or not menu.zwei_menues_aktiv %}active{% endif %}">
                        <div class="form-group">
                            <label>Men√º</label>
                            <input type="text" list="menu-options" name="menu_text" 
                                   value="{{ menu.description if menu and not menu.zwei_menues_aktiv else '' }}" 
                                   placeholder="z.B. Schnitzel mit Pommes">
                        </div>
                    </div>
                    
                    <div id="dual-menu" class="menu-inputs {% if menu and menu.zwei_menues_aktiv %}active{% endif %}">
                        <div class="form-group">
                            <label>Men√º 1</label>
                            <input type="text" list="menu-options" name="menu1_text" 
                                   value="{{ menu.menu1_name if menu else '' }}" 
                                   placeholder="Erstes Men√º">
                        </div>
                        <div class="form-group">
                            <label>Men√º 2</label>
                            <input type="text" list="menu-options" name="menu2_text" 
                                   value="{{ menu.menu2_name if menu else '' }}" 
                                   placeholder="Zweites Men√º">
                        </div>
                    </div>
                    
                    <datalist id="menu-options">
                        {% for preset in preset_menus %}
                        <option value="{{ preset.name }}">
                        {% endfor %}
                    </datalist>
                    
                    <button type="submit" name="save_menu" value="1" class="btn btn-primary" style="width: 100%;">
                        ‚úÖ Men√º speichern
                    </button>
                </form>
            </div>
            
            <!-- G√§ste Card -->
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">üë•</span>
                    <h2>G√§ste</h2>
                </div>
                
                <form method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="form-group">
                        <label>Anzahl G√§ste</label>
                        <input type="number" name="guest_count" value="{{ guest_count }}" min="0" max="50">
                    </div>
                    <button type="submit" name="guest_action" value="set" class="btn btn-primary" style="width: 100%;">
                        Speichern
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Angemeldete Personen -->
        <div class="card">
            <div class="card-header">
                <span class="card-icon">üìã</span>
                <h2>Angemeldete Personen ({{ users|length }})</h2>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Aktion</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>{{ user.name }}</td>
                        <td>
                            {% if user.id in registered_ids %}
                            <span class="badge badge-success">‚úì Angemeldet</span>
                            {% endif %}
                        </td>
                        <td>
                            <form method="post" style="display: inline;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="hidden" name="user_id" value="{{ user.id }}">
                                <button type="submit" class="btn {% if user.id in registered_ids %}btn-secondary{% else %}btn-primary{% endif %}" 
                                        style="padding: 6px 15px; font-size: 0.9em;">
                                    {{ 'Abmelden' if user.id in registered_ids else 'Anmelden' }}
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Neuen User anlegen -->
        <div class="card">
            <div class="card-header">
                <span class="card-icon">‚ûï</span>
                <h2>User-Verwaltung</h2>
            </div>
            
            <h3 style="margin-bottom: 15px; font-size: 1.3em;">Neuen User anlegen</h3>
            <form method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="grid grid-3">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" name="new_name" placeholder="Max Mustermann" required>
                    </div>
                    <div class="form-group">
                        <label>Personalnummer</label>
                        <input type="text" name="new_personal_number" placeholder="12345" required>
                    </div>
                    <div class="form-group">
                        <label>Karten-ID (optional)</label>
                        <input type="text" name="new_card_id" placeholder="RFID Karte">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">User anlegen</button>
            </form>
            
            <h3 style="margin: 30px 0 15px; font-size: 1.3em;">CSV-Import</h3>
            <form method="post" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="form-group">
                    <label>CSV-Datei hochladen</label>
                    <input type="file" name="csv_file" accept=".csv" required 
                           style="padding: 10px; background: rgba(255,255,255,0.05); border: 2px dashed rgba(255,255,255,0.2);">
                </div>
                <button type="submit" class="btn btn-primary">CSV importieren</button>
            </form>
        </div>
        
        <!-- Preset-Men√ºs -->
        <div class="card">
            <div class="card-header">
                <span class="card-icon">üìù</span>
                <h2>Vordefinierte Men√ºs</h2>
            </div>
            
            <form method="post" style="margin-bottom: 20px;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div style="display: flex; gap: 15px;">
                    <input type="text" name="new_preset_menu" placeholder="Neues Men√º hinzuf√ºgen" 
                           style="flex: 1;" required>
                    <button type="submit" name="add_preset_menu" value="1" class="btn btn-primary">
                        Hinzuf√ºgen
                    </button>
                </div>
            </form>
            
            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                {% for preset in preset_menus %}
                <div class="preset-tag">
                    <span>{{ preset.name }}</span>
                    <form method="post" style="display: inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="delete_preset_id" value="{{ preset.id }}">
                        <button type="submit" name="delete_preset_menu" value="1" class="preset-delete-btn">
                            ‚úï
                        </button>
                    </form>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- User bearbeiten & l√∂schen -->
        <div class="card">
            <div class="card-header">
                <span class="card-icon">‚úèÔ∏è</span>
                <h2>Alle User</h2>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Personalnummer</th>
                        <th>Karten-ID</th>
                        <th>QR-Code</th>
                        <th>Aktionen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>{{ user.name }}</td>
                        <td>{{ user.personal_number }}</td>
                        <td>{{ user.card_id or '-' }}</td>
                        <td>
                            <a href="/qr/{{ user.id }}" target="_blank" class="btn btn-secondary" 
                               style="padding: 6px 12px; font-size: 0.85em;">
                                üì± QR
                            </a>
                        </td>
                        <td>
                            <button class="btn btn-secondary edit-user-btn"
                                    data-id="{{ user.id }}"
                                    data-name="{{ user.name }}"
                                    data-pnr="{{ user.personal_number }}"
                                    data-card="{{ user.card_id or '' }}"
                                    style="padding: 6px 12px; font-size: 0.85em; margin-right: 5px;">
                                ‚úèÔ∏è
                            </button>
                            <form method="post" style="display: inline;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="hidden" name="delete_user" value="{{ user.id }}">
                                <button type="submit" class="btn btn-secondary delete-user-btn"
                                        data-name="{{ user.name }}"
                                        style="padding: 6px 12px; font-size: 0.85em; background: rgba(239,68,68,0.2);">
                                    üóëÔ∏è
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Edit User Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2>User bearbeiten</h2>
            <form method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" id="edit_user_id" name="edit_user">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="edit_name" name="edit_name" required>
                </div>
                <div class="form-group">
                    <label>Personalnummer</label>
                    <input type="text" id="edit_personal_number" name="edit_personal_number" required>
                </div>
                <div class="form-group">
                    <label>Karten-ID</label>
                    <input type="text" id="edit_card_id" name="edit_card_id">
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Speichern</button>
                    <button type="button" onclick="closeEditModal()" class="btn btn-secondary" style="flex: 1;">
                        Abbrechen
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='js/pages/admin.js') }}" defer></script>
</body>
</html>
