<!DOCTYPE html>
<html lang="de" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="google" content="notranslate">
    <meta name="color-scheme" content="dark">
    <title>Admin â€“ FoodBot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin.css') }}">
</head>
<body>
    <header class="topbar">
        <h1 class="topbar__title">âš™ï¸ Admin</h1>
        <nav class="topbar__nav">
            <a href="/admin/weekly">ğŸ“… Wochenplan</a>
            <a href="/stats">ğŸ“Š Statistiken</a>
            <a href="/history">ğŸ“œ Historie</a>
            <a href="/kitchen">ğŸ³ KÃ¼che</a>
            <a href="/">ğŸ“¡ Touch</a>
            <a href="/logout" class="topbar__logout">ğŸšª Logout</a>
        </nav>
    </header>

    <main class="content">
        {% if message %}
        <div class="flash">{{ message }}</div>
        {% endif %}

        <!-- Tab-Navigation -->
        <nav class="tabs" role="tablist">
            <button class="tab active" data-tab="day" role="tab">ğŸ“‹ Tagesplanung</button>
            <button class="tab" data-tab="users" role="tab">ğŸ‘¥ User-Verwaltung</button>
        </nav>

        <!-- =================== TAB 1: Tagesplanung =================== -->
        <div class="tab-panel active" id="tab-day" role="tabpanel">

            <div class="row-2">
                <!-- MenÃ¼ -->
                <section class="card">
                    <h2 class="card__heading">ğŸ½ï¸ MenÃ¼ fÃ¼r heute</h2>

                    <form method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                        <label class="check-row">
                            <input type="checkbox" id="zwei_menues" name="zwei_menues_aktiv" value="1"
                                   {% if menu and menu.zwei_menues_aktiv %}checked{% endif %}
                                   onchange="toggleMenuInputs(this.checked)">
                            <span>Zwei MenÃ¼s anbieten</span>
                        </label>

                        <div class="info-box">
                            <div class="info-box__row">
                                <label class="check-row">
                                    <input type="checkbox" name="deadline_enabled" value="1"
                                           {% if not menu or menu.deadline_enabled %}checked{% endif %}>
                                    <span>â° Anmeldefrist</span>
                                </label>
                                <div class="time-input">
                                    <span>Bis</span>
                                    <input type="time" name="registration_deadline"
                                           value="{{ menu.registration_deadline if menu else '19:45' }}">
                                    <span>Uhr</span>
                                </div>
                            </div>
                        </div>

                        <div id="single-menu" class="menu-inputs {% if not menu or not menu.zwei_menues_aktiv %}active{% endif %}">
                            <div class="field">
                                <label>MenÃ¼</label>
                                <input type="text" list="menu-options" name="menu_text"
                                       value="{{ menu.description if menu and not menu.zwei_menues_aktiv else '' }}"
                                       placeholder="z.B. Schnitzel mit Pommes">
                            </div>
                        </div>

                        <div id="dual-menu" class="menu-inputs {% if menu and menu.zwei_menues_aktiv %}active{% endif %}">
                            <div class="field">
                                <label>MenÃ¼ 1</label>
                                <input type="text" list="menu-options" name="menu1_text"
                                       value="{{ menu.menu1_name if menu else '' }}"
                                       placeholder="Erstes MenÃ¼">
                            </div>
                            <div class="field">
                                <label>MenÃ¼ 2</label>
                                <input type="text" list="menu-options" name="menu2_text"
                                       value="{{ menu.menu2_name if menu else '' }}"
                                       placeholder="Zweites MenÃ¼">
                            </div>
                        </div>

                        <datalist id="menu-options">
                            {% for preset in preset_menus %}
                            <option value="{{ preset.name }}">
                            {% endfor %}
                        </datalist>

                        <button type="submit" name="save_menu" value="1" class="btn-action">
                            âœ… MenÃ¼ speichern
                        </button>
                    </form>
                </section>

                <!-- GÃ¤ste -->
                <section class="card">
                    <h2 class="card__heading">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ GÃ¤ste</h2>

                    <form method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="field">
                            <label>Anzahl GÃ¤ste</label>
                            <input type="number" name="guest_count" value="{{ guest_count }}" min="0" max="50">
                        </div>
                        <button type="submit" name="guest_action" value="set" class="btn-action">
                            ğŸ’¾ Speichern
                        </button>
                    </form>
                </section>
            </div>

            <!-- Angemeldete Personen -->
            <section class="card">
                <h2 class="card__heading">
                    ğŸ“‹ Angemeldete Personen
                    <span class="count-badge">{{ users|length }}</span>
                </h2>

                {% if users %}
                <div class="reg-list">
                    {% for user in users %}
                    <div class="reg-item {% if user.id in registered_ids %}reg-item--on{% endif %}">
                        <span class="reg-item__name">{{ user.name }}</span>
                        <form method="post" class="reg-item__form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="user_id" value="{{ user.id }}">
                            <button type="submit"
                                    class="btn-toggle {% if user.id in registered_ids %}btn-toggle--off{% else %}btn-toggle--on{% endif %}">
                                {{ 'Abmelden' if user.id in registered_ids else 'Anmelden' }}
                            </button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="empty-hint">Keine User vorhanden</p>
                {% endif %}
            </section>
        </div>

        <!-- =================== TAB 2: User-Verwaltung =================== -->
        <div class="tab-panel" id="tab-users" role="tabpanel">

            <!-- Neuen User anlegen -->
            <section class="card">
                <h2 class="card__heading">â• Neuen User anlegen</h2>

                <form method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="row-3">
                        <div class="field">
                            <label>Name</label>
                            <input type="text" name="new_name" placeholder="Max Mustermann" required>
                        </div>
                        <div class="field">
                            <label>Personalnummer</label>
                            <input type="text" name="new_personal_number" placeholder="12345" required>
                        </div>
                        <div class="field">
                            <label>Karten-ID (optional)</label>
                            <input type="text" name="new_card_id" placeholder="RFID Karte">
                        </div>
                    </div>
                    <button type="submit" class="btn-action">ğŸ‘¤ User anlegen</button>
                </form>

                <hr class="divider">

                <h3 class="sub-heading">ğŸ“‚ CSV-Import</h3>
                <form method="post" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="field">
                        <label>CSV-Datei hochladen</label>
                        <input type="file" name="csv_file" accept=".csv" required class="file-input">
                    </div>
                    <button type="submit" class="btn-action">ğŸ“¤ CSV importieren</button>
                </form>
            </section>

            <!-- Vordefinierte MenÃ¼s -->
            <section class="card">
                <h2 class="card__heading">ğŸ“ Vordefinierte MenÃ¼s</h2>

                <form method="post" class="preset-add">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="text" name="new_preset_menu" placeholder="Neues MenÃ¼ hinzufÃ¼gen" required>
                    <button type="submit" name="add_preset_menu" value="1" class="btn-action btn-action--compact">
                        â• HinzufÃ¼gen
                    </button>
                </form>

                <div class="preset-tags">
                    {% for preset in preset_menus %}
                    <div class="preset-tag">
                        <span>{{ preset.name }}</span>
                        <form method="post" class="preset-tag__form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="delete_preset_id" value="{{ preset.id }}">
                            <button type="submit" name="delete_preset_menu" value="1"
                                    class="preset-tag__x" title="LÃ¶schen">âœ•</button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
            </section>

            <!-- Alle User -->
            <section class="card">
                <h2 class="card__heading">
                    âœï¸ Alle User
                    <span class="count-badge">{{ users|length }}</span>
                </h2>

                {% if users %}
                <div class="user-list">
                    {% for user in users %}
                    <div class="user-row">
                        <div class="user-row__info">
                            <span class="user-row__name">{{ user.name }}</span>
                            <span class="user-row__meta">Nr. {{ user.personal_number }}{% if user.card_id %} Â· Karte: {{ user.card_id }}{% endif %}</span>
                        </div>
                        <div class="user-row__actions">
                            <a href="/qr/{{ user.id }}" target="_blank" class="btn-icon" title="QR-Code">ğŸ“±</a>
                            <button class="btn-icon edit-user-btn" title="Bearbeiten"
                                    data-id="{{ user.id }}"
                                    data-name="{{ user.name }}"
                                    data-pnr="{{ user.personal_number }}"
                                    data-card="{{ user.card_id or '' }}">âœï¸</button>
                            <form method="post" class="inline-form">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="hidden" name="delete_user" value="{{ user.id }}">
                                <button type="submit" class="btn-icon btn-icon--danger delete-user-btn"
                                        data-name="{{ user.name }}" title="LÃ¶schen">ğŸ—‘ï¸</button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="empty-hint">Keine User vorhanden</p>
                {% endif %}
            </section>
        </div>
    </main>

    <!-- Edit User Modal -->
    <div id="editModal" class="modal">
        <div class="modal__box">
            <h2 class="modal__title">User bearbeiten</h2>
            <form method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" id="edit_user_id" name="edit_user">
                <div class="field">
                    <label>Name</label>
                    <input type="text" id="edit_name" name="edit_name" required>
                </div>
                <div class="field">
                    <label>Personalnummer</label>
                    <input type="text" id="edit_personal_number" name="edit_personal_number" required>
                </div>
                <div class="field">
                    <label>Karten-ID</label>
                    <input type="text" id="edit_card_id" name="edit_card_id">
                </div>
                <div class="modal__actions">
                    <button type="submit" class="btn-action">ğŸ’¾ Speichern</button>
                    <button type="button" onclick="closeEditModal()" class="btn-cancel">Abbrechen</button>
                </div>
            </form>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/pages/admin.js') }}" defer></script>
</body>
</html>
