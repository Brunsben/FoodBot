<!DOCTYPE html>
<html lang="de" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="google" content="notranslate">
    <meta name="color-scheme" content="dark">
    <meta name="theme-color" content="#0f172a">
    <title>Essensanmeldung</title>
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/components.css">
    <link rel="stylesheet" href="/static/css/layouts.css">
    <link rel="stylesheet" href="/static/css/components/animations.css">
        <link rel="stylesheet" href="/static/css/pages/touch.css">
        <link rel="stylesheet" href="/static/css/components/button.css">
</head>
<body>
    <div class="page">
    <header class="page-header">
        <h1 class="page-title">&#9776; Essensanmeldung</h1>
    </header>
    
    <main class="main-content">
        <div class="menu-card elastic-card glass-ultra">
            <div class="menu-label">Heutiges Menü</div>
            <div id="menuDisplay" class="menu-text">
                {% if menu %}
                    {% if menu.zwei_menues_aktiv %}
                        <div class="menu-grid">
                            <div class="menu-item">
                                <div class="menu-item-label">Menü 1</div>
                                <div class="menu-item-name">{{ menu.menu1_name }}</div>
                            </div>
                            <div class="menu-item">
                                <div class="menu-item-label">Menü 2</div>
                                <div class="menu-item-name">{{ menu.menu2_name }}</div>
                            </div>
                        </div>
                    {% else %}
                        {{ menu.description }}
                    {% endif %}
                {% else %}
                    <span style="color: var(--text-muted);">Kein Menü verfügbar</span>
                {% endif %}
            </div>
        </div>
        
        <div class="scanner-area elastic-hover">
            <div class="scanner-icon scan-pulse" id="scannerIcon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="1em" height="1em">
                    <path d="M2 10a8 8 0 0 1 8-8"/>
                    <path d="M2 14a12 12 0 0 1 12-12"/>
                    <path d="M2 18A16 16 0 0 1 18 2"/>
                    <line x1="2" y1="22" x2="2" y2="22.01"/>
                    <rect x="7" y="14" width="10" height="8" rx="2"/>
                    <line x1="12" y1="14" x2="12" y2="11"/>
                </svg>
            </div>
            <div class="scanner-text" id="scannerText">Karte auflegen</div>
            
            <button class="btn btn-primary ripple-btn" id="showInputBtn" onclick="showInput()">
                oder mit Personalnummer
            </button>
            
            <div id="inputWrapper" class="numpad-wrapper" style="display: none;">
                <form onsubmit="handleSubmit(event)">
                    <div class="floating-label-group">
                        <input type="text" id="personalNumberInput" name="personal_number" class="numpad-display floating-label-input" placeholder=" " required autocomplete="off" aria-label="Personalnummer" inputmode="text" maxlength="20">
                        <label for="personalNumberInput" class="floating-label">Personalnummer</label>
                        <!-- Verstecktes Feld für Ausweisnummer (card_id) -->
                        <input type="hidden" id="cardIdInput" name="card_id">
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button type="submit" class="btn btn-primary ripple-btn" style="flex: 1;">✓ Anmelden</button>
                        <button type="button" class="btn btn-secondary ripple-btn" onclick="hideInput()" style="flex: 1;">✕ Abbrechen</button>
                    </div>
                </form>
            </div>
        </div>
    </main>
    
    <div id="statusPopup" class="status-popup">
        <div class="status-icon" id="statusIcon">✓</div>
        <div class="status-title" id="statusTitle">Angemeldet</div>
        <div class="status-subtitle" id="statusSubtitle">Max Mustermann</div>
    </div>
    
    <div id="choiceOverlay" class="choice-overlay">
        <div class="choice-box">
            <div class="choice-title">Welches Menü?</div>
            <div class="choice-buttons">
                <button class="choice-btn" onclick="selectMenu(1)" id="choice1">Menü 1</button>
                <button class="choice-btn" onclick="selectMenu(2)" id="choice2">Menü 2</button>
            </div>
        </div>
    </div>
    
    <!-- Fullscreen Funktion muss VOR dem Button definiert werden -->
    <script>
    // ==================== FULLSCREEN FUNKTION (GLOBAL) ====================
    function enterFullscreen() {
        console.log('enterFullscreen() aufgerufen');
        const elem = document.documentElement;
        if (elem.requestFullscreen) {
            elem.requestFullscreen().catch(err => {
                console.log('Fullscreen Fehler:', err);
                alert('Vollbild konnte nicht aktiviert werden: ' + err.message);
            });
        } else if (elem.webkitRequestFullscreen) { // Safari
            elem.webkitRequestFullscreen();
        } else if (elem.msRequestFullscreen) { // IE11
            elem.msRequestFullscreen();
        } else {
            alert('Vollbild wird von diesem Browser nicht unterstützt.');
        }
    }
    console.log('enterFullscreen Funktion definiert:', typeof enterFullscreen);
    </script>
    
    <!-- Fullscreen Button -->
    <button id="fullscreenBtn" class="btn btn-secondary ripple-btn" onclick="enterFullscreen()" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; padding: 0.8rem 1.5rem; font-size: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
        ⛶ Vollbild
    </button>
    </div>
    
    <script src="/static/js/animations.js" defer></script>
    <script src="/static/js/pages/touch.js?v=2" defer></script>
    <script>
    // ==================== SCANNER-ERFASSUNG OHNE INPUT-FELD ====================
    // Da Chrome bei Keyboard-Events die Shortcut-Leiste zeigt, arbeiten wir
    // komplett ohne Input-Feld und erfassen direkt über Document-Events
    
    document.addEventListener('DOMContentLoaded', () => {
        let scanBuffer = '';
        let scanTimeout = null;
        const SCAN_TIMEOUT = 150; // ms zwischen Zeichen
        
        console.log('Scanner-Erfassung aktiv (kein Input-Feld)');
        
        // Erfasse alle Tastatur-Events auf Document-Level
        document.addEventListener('keydown', function(e) {
            const inputWrapper = document.getElementById('inputWrapper');
            
            // Ignoriere wenn manuelles Input-Feld offen ist
            if (inputWrapper && inputWrapper.style.display === 'block') {
                return;
            }
            
            // Ignoriere Navigation-Tasten
            if (e.key === 'Tab' || e.key === 'Escape' || e.key === 'F5') {
                return;
            }
            
            // Verhindere Browser-Aktionen
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Key:', e.key, 'Buffer:', scanBuffer);
            
            if (e.key === 'Enter') {
                // Scan komplett - verarbeite Buffer
                if (scanBuffer.length > 3) {
                    console.log('✓ Scan komplett:', scanBuffer);
                    processScan(scanBuffer);
                }
                scanBuffer = '';
                clearTimeout(scanTimeout);
            } else if (e.key.length === 1) {
                // Sammle Zeichen (nur einzelne Zeichen, keine Modifier)
                scanBuffer += e.key;
                
                // Auto-Reset nach Timeout (falls kein Enter kommt)
                clearTimeout(scanTimeout);
                scanTimeout = setTimeout(() => {
                    if (scanBuffer.length > 3) {
                        console.log('⏱ Timeout - sende Buffer:', scanBuffer);
                        processScan(scanBuffer);
                    }
                    scanBuffer = '';
                }, SCAN_TIMEOUT);
            }
        }, { capture: true, passive: false });
        
        // Verarbeite gescannte Karte
        async function processScan(cardId) {
            console.log('Sende Scan an Server:', cardId);
            try {
                const response = await fetch('/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: `card_id=${encodeURIComponent(cardId)}`
                });
                
                console.log('Response Status:', response.status);
                const data = await response.json();
                console.log('Response Data:', data);
                
                if (data.need_menu_choice) {
                    // Menüauswahl zeigen (touch.js Funktion)
                    if (typeof showMenuChoice === 'function') {
                        showMenuChoice(data.user_id, cardId, null, data.menu1, data.menu2);
                    }
                } else {
                    // Status-Popup anzeigen (touch.js Funktion)
                    if (typeof showStatus === 'function') {
                        const lines = data.message.split('\n');
                        showStatus(data.status, lines[0], lines[1] || '');
                    }
                }
            } catch (error) {
                console.error('Scan-Verarbeitung fehlgeschlagen:', error);
                if (typeof showStatus === 'function') {
                    showStatus('error', 'Fehler', 'Verbindung fehlgeschlagen');
                }
            }
        }
        
        // ==================== FULLSCREEN MODUS FÜR TABLETS ====================
        let fullscreenAttempted = false;
        function tryFullscreen() {
            if (!fullscreenAttempted && !document.fullscreenElement) {
                enterFullscreen();
                fullscreenAttempted = true;
            }
        }
        
        // Bei erstem Click/Touch in Fullscreen gehen
        document.body.addEventListener('click', tryFullscreen, { once: true });
        document.body.addEventListener('touchstart', tryFullscreen, { once: true });
        
        // Nutze existierenden Fullscreen Button
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        if (fullscreenBtn) {
            fullscreenBtn.onclick = (e) => {
                e.stopPropagation();
                enterFullscreen();
            };
            
            // Zeige Button nur wenn nicht im Fullscreen
            function updateFullscreenBtn() {
                if (document.fullscreenElement || document.webkitFullscreenElement) {
                    fullscreenBtn.style.display = 'none';
                } else {
                    fullscreenBtn.style.display = 'block';
                }
            }
            
            document.addEventListener('fullscreenchange', updateFullscreenBtn);
            document.addEventListener('webkitfullscreenchange', updateFullscreenBtn);
            updateFullscreenBtn();
            
            console.log('Fullscreen-Button initialisiert');
        }
    });
    </script>
</body>
</html>
