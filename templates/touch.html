<!DOCTYPE html>
<html lang="de" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="google" content="notranslate">
    <meta name="color-scheme" content="dark">
    <meta name="theme-color" content="#0f172a">
    <title>Essensanmeldung</title>
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/components.css">
    <link rel="stylesheet" href="/static/css/layouts.css">
        <link rel="stylesheet" href="/static/css/pages/touch.css">
        <link rel="stylesheet" href="/static/css/components/button.css">
</head>
<body>
    <div class="page">
    <header class="page-header">
        <h1 class="page-title">&#9776; Essensanmeldung</h1>
    </header>
    
    <main class="main-content">
            <!-- Unsichtbares Input für Kartenleser-Scans auf Tablets (außerhalb des Viewports) -->
            <input type="text" id="hiddenScanInput" style="position:absolute;left:-9999px;top:0;width:1px;height:1px;opacity:0;z-index:-1;" autocomplete="off" inputmode="none" aria-hidden="true" tabindex="-1">
        <div class="menu-card">
            <div class="menu-label">Heutiges Menü</div>
            <div id="menuDisplay" class="menu-text">
                {% if menu %}
                    {% if menu.zwei_menues_aktiv %}
                        <div class="menu-grid">
                            <div class="menu-item">
                                <div class="menu-item-label">Menü 1</div>
                                <div class="menu-item-name">{{ menu.menu1_name }}</div>
                            </div>
                            <div class="menu-item">
                                <div class="menu-item-label">Menü 2</div>
                                <div class="menu-item-name">{{ menu.menu2_name }}</div>
                            </div>
                        </div>
                    {% else %}
                        {{ menu.description }}
                    {% endif %}
                {% else %}
                    <span style="color: var(--text-muted);">Kein Menü verfügbar</span>
                {% endif %}
            </div>
        </div>
        
        <div class="scanner-area">
            <div class="scanner-icon" id="scannerIcon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="1em" height="1em">
                    <path d="M2 10a8 8 0 0 1 8-8"/>
                    <path d="M2 14a12 12 0 0 1 12-12"/>
                    <path d="M2 18A16 16 0 0 1 18 2"/>
                    <line x1="2" y1="22" x2="2" y2="22.01"/>
                    <rect x="7" y="14" width="10" height="8" rx="2"/>
                    <line x1="12" y1="14" x2="12" y2="11"/>
                </svg>
            </div>
            <div class="scanner-text" id="scannerText">Karte auflegen</div>
            
            <button class="btn btn-primary" id="showNumpadBtn" onclick="showNumpad()">
                oder mit Personalnummer
            </button>
            
            <div id="numpadWrapper" class="numpad-wrapper" style="display: none;">
                <form onsubmit="handleSubmit(event)">
                    <div class="floating-label-group">
                        <input type="text" id="numpadDisplay" name="personal_number" class="numpad-display floating-label-input" placeholder=" " readonly required autocomplete="off" aria-label="Personalnummer" inputmode="numeric">
                        <label for="numpadDisplay" class="floating-label">Personalnummer</label>
                        <!-- Verstecktes Feld für Ausweisnummer (card_id) -->
                        <input type="hidden" id="cardIdInput" name="card_id">
                    </div>
                    
                    <div class="numpad">
                        <button type="button" class="numpad-btn" onclick="addDigit('1')">1</button>
                        <button type="button" class="numpad-btn" onclick="addDigit('2')">2</button>
                        <button type="button" class="numpad-btn" onclick="addDigit('3')">3</button>
                        <button type="button" class="numpad-btn" onclick="addDigit('4')">4</button>
                        <button type="button" class="numpad-btn" onclick="addDigit('5')">5</button>
                        <button type="button" class="numpad-btn" onclick="addDigit('6')">6</button>
                        <button type="button" class="numpad-btn" onclick="addDigit('7')">7</button>
                        <button type="button" class="numpad-btn" onclick="addDigit('8')">8</button>
                        <button type="button" class="numpad-btn" onclick="addDigit('9')">9</button>
                        <button type="button" class="numpad-btn delete" onclick="deleteDigit()">&#9003;</button>
                        <button type="button" class="numpad-btn" onclick="addDigit('0')">0</button>
                        <button type="submit" class="numpad-btn submit">&#10003;</button>
                    </div>
                    
                    <button type="button" class="numpad-cancel" onclick="hideNumpad()">&#10005; Abbrechen</button>
                </form>
            </div>
        </div>
    </main>
    
    <div id="statusPopup" class="status-popup">
        <div class="status-icon" id="statusIcon">✓</div>
        <div class="status-title" id="statusTitle">Angemeldet</div>
        <div class="status-subtitle" id="statusSubtitle">Max Mustermann</div>
    </div>
    
    <div id="choiceOverlay" class="choice-overlay">
        <div class="choice-box">
            <div class="choice-title">Welches Menü?</div>
            <div class="choice-buttons">
                <button class="choice-btn" onclick="selectMenu(1)" id="choice1">Menü 1</button>
                <button class="choice-btn" onclick="selectMenu(2)" id="choice2">Menü 2</button>
            </div>
        </div>
    </div>
    </div>
    
    <script src="/static/js/pages/touch.js" defer></script>
    <script>
    // Immer das unsichtbare Feld fokussieren, außer wenn das Numpad offen ist
    function focusHiddenInput() {
        const numpadWrapper = document.getElementById('numpadWrapper');
        if (numpadWrapper && numpadWrapper.style.display !== 'block') {
            const input = document.getElementById('hiddenScanInput');
            if (input && document.activeElement !== input) {
                console.log('Fokussiere Hidden Input, aktueller Fokus:', document.activeElement.id);
                input.focus();
            }
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        const hiddenInput = document.getElementById('hiddenScanInput');
        
        console.log('Touch-Interface geladen, hiddenScanInput vorhanden:', !!hiddenInput);
        console.log('User Agent:', navigator.userAgent);
        
        // Keyboard-Events auf Document-Ebene abfangen
        let scanBuffer = '';
        let scanTimeout = null;
        
        // Global Event Logger - loggt ALLES
        window.addEventListener('keydown', function(e) {
            console.log('WINDOW keydown:', e.key, 'keyCode:', e.keyCode, 'code:', e.code);
        }, true);
        
        function handleKeyEvent(e) {
            console.log('handleKeyEvent aufgerufen:', e.type, e.key, e.keyCode);
            
            const numpadWrapper = document.getElementById('numpadWrapper');
            // Nur abfangen wenn Numpad NICHT offen ist
            if (numpadWrapper && numpadWrapper.style.display === 'block') {
                console.log('Numpad offen - ignoriere Event');
                return; // Numpad ist offen, normale Tastatur-Events erlauben
            }
            
            // Blockiere ALLE F-Tasten (F1-F12) und andere Shortcuts
            const isFunctionKey = (e.key && e.key.match(/^F\d+$/i)) || (e.keyCode >= 112 && e.keyCode <= 123);
            
            if (isFunctionKey) {
                console.log('!!! F-Taste BLOCKIERT !!!:', e.key, 'keyCode:', e.keyCode);
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                return false;
            }
        }
        
        // Blockiere F-Tasten auf allen Event-Typen auf Window UND Document
        ['keydown', 'keyup', 'keypress'].forEach(eventType => {
            window.addEventListener(eventType, handleKeyEvent, true);
            document.addEventListener(eventType, handleKeyEvent, true);
        });
        
        document.addEventListener('keydown', function(e) {
            const numpadWrapper = document.getElementById('numpadWrapper');
            if (numpadWrapper && numpadWrapper.style.display === 'block') {
                return;
            }
            
            // Sammle alphanumerische Zeichen
            if (e.key && e.key.length === 1 || e.key === 'Enter') {
                
                if (e.key === 'Enter') {
                    // Enter = Scan ist komplett
                    console.log('Enter erkannt, Scan-Buffer:', scanBuffer);
                    if (scanBuffer.length > 3 && hiddenInput) {
                        hiddenInput.value = scanBuffer;
                        hiddenInput.dispatchEvent(new Event('input', {bubbles: true}));
                    }
                    scanBuffer = '';
                    clearTimeout(scanTimeout);
                } else {
                    // Zeichen zum Buffer hinzufügen
                    scanBuffer += e.key;
                    console.log('Zeichen gesammelt:', e.key, 'Buffer:', scanBuffer);
                    
                    // Auto-Reset nach 100ms Pause (falls kein Enter kommt)
                    clearTimeout(scanTimeout);
                    scanTimeout = setTimeout(() => {
                        if (scanBuffer.length > 3) {
                            console.log('Timeout - sende Buffer:', scanBuffer);
                            hiddenInput.value = scanBuffer;
                            hiddenInput.dispatchEvent(new Event('input', {bubbles: true}));
                        }
                        scanBuffer = '';
                    }, 100);
                }
            }
        });
        
        // Einfach konstant fokussieren, inputmode="none" verhindert Tastatur
        focusHiddenInput();
        document.body.addEventListener('click', focusHiddenInput, {passive: true});
        
        // Alle 500ms sicherstellen dass Fokus da ist
        setInterval(focusHiddenInput, 500);
        
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) focusHiddenInput();
        });
    });
    // Wenn Scan erkannt, Ausweisnummer verarbeiten und anmelden
    const scanInput = document.getElementById('hiddenScanInput');
    if (scanInput) {
        scanInput.addEventListener('input', function(e) {
            const val = e.target.value.trim();
            console.log('Scan input erkannt:', val, 'Länge:', val.length);
            
            if(val.length > 3) { // Mindestlänge für Kartennummer
                const cardIdInput = document.getElementById('cardIdInput');
                const numpadWrapper = document.getElementById('numpadWrapper');
                const form = document.querySelector('.numpad-wrapper form');
                
                console.log('Verarbeite Scan:', val);
                
                if (cardIdInput && form && numpadWrapper && numpadWrapper.style.display !== 'block') {
                    // Schreibe Ausweisnummer in das versteckte Feld
                    cardIdInput.value = val;
                    e.target.value = '';
                    console.log('Sende Formular mit card_id:', val);
                    // Formular absenden
                    form.dispatchEvent(new Event('submit', {cancelable: true, bubbles: true}));
                } else {
                    console.log('Formular kann nicht abgesendet werden - Elemente fehlen oder Numpad offen');
                }
            }
        });
    }
    </script>
</body>
</html>
